name: Backport PR

on:
  pull_request_target:
    types: [labeled]

jobs:
  backport:
    if: |
      !github.event.repository.fork &&
      startsWith(github.event.label.name, 'backport/3.') &&
      github.event.action == 'labeled'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Extract version from label
        id: extract
        run: |
          LABEL="${{ github.event.label.name }}"
          if [[ "$LABEL" =~ ^backport/3\.([0-9]+)$ ]]; then
            VERSION="3.${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "branch=release/$VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "Error: Invalid label format '$LABEL'. Expected 'backport/3.X' where X is an integer."
            exit 1
          fi

      - name: Get PR info
        id: pr_info
        uses: actions/github-script@v8
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.pull_request.number }}
            });
            core.setOutput('title', pr.data.title);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('head_repo', pr.data.head.repo.full_name);

      - name: Checkout target release branch
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.extract.outputs.branch }}
          fetch-depth: 0

      - name: Fetch PR changes and simulate squash merge
        id: apply_changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch "https://github.com/${{ steps.pr_info.outputs.head_repo }}" "${{ steps.pr_info.outputs.head_sha }}"
          if ! git merge --squash "${{ steps.pr_info.outputs.head_sha }}" --no-edit; then
            echo "Merge failed (likely due to conflicts). Skipping backport."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if git diff --cached --quiet; then
            echo "No changes to backport."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            git commit -m "[Backport/${{ steps.extract.outputs.version }}] ${{ steps.pr_info.outputs.title }}

  Backport of PR #${{ github.event.pull_request.number }}."
  fi

- name: Push backport branch
  if: steps.apply_changes.outputs.has_changes == 'true'
  id: push
  run: |
    BACKPORT_BRANCH="backport/pr-${{ github.event.pull_request.number }}-to-${{ steps.extract.outputs.version }}"
    git push origin HEAD:"$BACKPORT_BRANCH"
    echo "backport_branch=$BACKPORT_BRANCH" >> "$GITHUB_OUTPUT"

- name: Create Backport Pull Request
  if: steps.apply_changes.outputs.has_changes == 'true'
  uses: actions/github-script@v8
  with:
    script: |
      const { owner, repo } = context.repo;
      const originalPrNumber = ${{ github.event.pull_request.number }};
      const version = "${{ steps.extract.outputs.version }}";
      const title = `[Backport/${version}] ${{ steps.pr_info.outputs.title }}`;
      const body = `Automated backport of #${originalPrNumber} to \`${{ steps.extract.outputs.branch }}\`.

Original PR: #${originalPrNumber}
Commit: ${{ steps.pr_info.outputs.head_sha }}`;
  
  try {
  await github.rest.pulls.create({
  owner,
  repo,
  title,
  head: "${{ steps.push.outputs.backport_branch }}",
  base: "${{ steps.extract.outputs.branch }}",
  body
});
  console.log("Backport PR created successfully.");
} catch (error) {
  const msg = error.message || '';
  if (error.status === 422 && msg.includes('A pull request already exists')) {
  console.log("Backport PR already exists. Skipping.");
} else {
  throw error;
}
}