name: Backport PR

on:
  pull_request:
    types: [ labeled ]
  pull_request_target:
    types: [ labeled ]

jobs:
  backport:
    if: |
      startsWith(github.event.label.name, 'backport/3.') &&
      github.event.action == 'labeled'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Extract version from label
        id: extract
        run: |
          LABEL="${{ github.event.label.name }}"
          if [[ "$LABEL" =~ ^backport/3\.([0-9]+)$ ]]; then
            VERSION="3.${BASH_REMATCH[1]}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "branch=release/$VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "Error: Invalid label format '$LABEL'."
            exit 1
          fi

      - name: Get PR info
        id: pr_info
        uses: actions/github-script@v8
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.pull_request.number }}
            });
            core.setOutput('title', pr.data.title);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('head_repo', pr.data.head.repo.full_name);

      - name: Checkout target release branch
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.extract.outputs.branch }}
          fetch-depth: 0

      - name: Fetch PR changes and simulate squash merge
        id: apply_changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch "https://github.com/${{ steps.pr_info.outputs.head_repo }}" "${{ steps.pr_info.outputs.head_sha }}"
          git merge --squash "${{ steps.pr_info.outputs.head_sha }}" --no-edit || true
          git add -A
          git commit -m "[release/${{ steps.extract.outputs.version }}] ${{ steps.pr_info.outputs.title }}
          Backport of PR #${{ github.event.pull_request.number }}." || {
            echo "No changes to commit. Skipping backport PR creation."
            exit 0
          }

      - name: Push backport branch
        id: push
        run: |
          BACKPORT_BRANCH="pr-backport/${{ steps.extract.outputs.version }}/pr-${{ github.event.pull_request.number }}"
          git push origin HEAD:"$BACKPORT_BRANCH"
          echo "backport_branch=$BACKPORT_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Create Backport Pull Request
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            const originalPrNumber = ${{ github.event.pull_request.number }};
            const version = "${{ steps.extract.outputs.version }}";
            const title = `[release/${version}] ${{ steps.pr_info.outputs.title }}`;
            const body = `[Backport] #${originalPrNumber} -> \`${{ steps.extract.outputs.branch }}\`\n\n> ⚠️ This backport may contain merge conflicts. Please resolve them manually.`;
            await github.rest.pulls.create({
              owner,
              repo,
              title,
              head: "${{ steps.push.outputs.backport_branch }}",
              base: "${{ steps.extract.outputs.branch }}",
              body
            });