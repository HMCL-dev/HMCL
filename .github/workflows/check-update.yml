name: Check Update

on:
  workflow_dispatch:
  schedule:
    - cron: '30 * * * *'

permissions:
  contents: write

jobs:
  check-update:
    if: ${{ github.repository_owner == 'HMCL-dev' }}
    strategy:
      matrix:
        channel: [dev, stable]
        include:
          - channel: dev
            tag_prefix: v
            job_name: HMCL
          - channel: stable
            tag_prefix: release-
            job_name: HMCL-stable
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fetch tags
        run: git fetch --all --tags
      - name: Install tools
        run: sudo apt-get install -y jq
      - name: Fetch last version
        run: |
          wget -O ci.json "https://ci.huangyuhui.net/job/${{ matrix.job_name }}/lastSuccessfulBuild/api/json"
          
          export HMCL_EXE_FILE_NAME=`cat ci.json | jq -M -r '.artifacts[] | select(.fileName | endswith(".exe")) | .fileName'`
          if [ -z `echo $HMCL_EXE_FILE_NAME | grep -E "^HMCL-[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?\.exe\$"` ]; then exit 1; fi
          
          export HMCL_VERSION=`echo "${HMCL_EXE_FILE_NAME%.exe}" | tail -c +6`
          export HMCL_COMMIT_SHA=`cat ci.json | jq -M -r '.actions[] | select(._class == "hudson.plugins.git.util.BuildData") | .lastBuiltRevision.SHA1'`

          if [ "${#HMCL_COMMIT_SHA}" != 40 ]; then exit 1; fi

          echo "HMCL_VERSION=$HMCL_VERSION" >> $GITHUB_ENV
          echo "HMCL_COMMIT_SHA=$HMCL_COMMIT_SHA" >> $GITHUB_ENV
          echo "HMCL_TAG_NAME=${{ matrix.tag_prefix }}$HMCL_VERSION" >> $GITHUB_ENV
      - name: Check for existing tags
        run: if [ -z "$(git tag -l "${{ env.HMCL_TAG_NAME }}")" ]; then echo "continue=true" >> $GITHUB_ENV; fi
      - name: Download artifacts
        if: ${{ env.continue == 'true' }}
        run: |
          wget "https://ci.huangyuhui.net/job/${{ matrix.job_name }}/lastSuccessfulBuild/artifact/HMCL/build/libs/HMCL-${{ env.HMCL_VERSION }}.exe"
          wget "https://ci.huangyuhui.net/job/${{ matrix.job_name }}/lastSuccessfulBuild/artifact/HMCL/build/libs/HMCL-${{ env.HMCL_VERSION }}.exe.sha256"
          wget "https://ci.huangyuhui.net/job/${{ matrix.job_name }}/lastSuccessfulBuild/artifact/HMCL/build/libs/HMCL-${{ env.HMCL_VERSION }}.jar"
          wget "https://ci.huangyuhui.net/job/${{ matrix.job_name }}/lastSuccessfulBuild/artifact/HMCL/build/libs/HMCL-${{ env.HMCL_VERSION }}.jar.sha256"
          wget "https://ci.huangyuhui.net/job/${{ matrix.job_name }}/lastSuccessfulBuild/artifact/HMCL/build/libs/HMCL-${{ env.HMCL_VERSION }}.sh"
          wget "https://ci.huangyuhui.net/job/${{ matrix.job_name }}/lastSuccessfulBuild/artifact/HMCL/build/libs/HMCL-${{ env.HMCL_VERSION }}.sh.sha256"
      - name: Generate release note
        if: ${{ env.continue == 'true' }}
        run: |
          if [[ "${{ matrix.channel }}" == "stable" ]]; then
            echo "**This version is a stable version.**" >> RELEASE_NOTE
            echo "" >> RELEASE_NOTE
          fi
          echo "The full changelogs can be found on the website: https://docs.hmcl.net/changelog/${{ matrix.channel }}.html" >> RELEASE_NOTE
          echo "" >> RELEASE_NOTE
          echo "*Notice: changelogs are written in Chinese.*" >> RELEASE_NOTE
          echo "" >> RELEASE_NOTE
          echo "| File Name | SHA-256 Checksum |"  >> RELEASE_NOTE
          echo "| ---  | --- |" >> RELEASE_NOTE
          echo "| [HMCL-${{ env.HMCL_VERSION }}.exe](https://github.com/HMCL-dev/HMCL/releases/download/${{ env.HMCL_TAG_NAME }}/HMCL-${{ env.HMCL_VERSION }}.exe) | \`$(cat HMCL-${{ env.HMCL_VERSION }}.exe.sha256)\` |" >> RELEASE_NOTE
          echo "| [HMCL-${{ env.HMCL_VERSION }}.jar](https://github.com/HMCL-dev/HMCL/releases/download/${{ env.HMCL_TAG_NAME }}/HMCL-${{ env.HMCL_VERSION }}.jar) | \`$(cat HMCL-${{ env.HMCL_VERSION }}.jar.sha256)\` |" >> RELEASE_NOTE
          echo "| [HMCL-${{ env.HMCL_VERSION }}.sh](https://github.com/HMCL-dev/HMCL/releases/download/${{ env.HMCL_TAG_NAME }}/HMCL-${{ env.HMCL_VERSION }}.sh) | \`$(cat HMCL-${{ env.HMCL_VERSION }}.sh.sha256)\` |" >> RELEASE_NOTE
      - name: Create release
        if: ${{ env.continue == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          body_path: RELEASE_NOTE
          files: |
            HMCL-${{ env.HMCL_VERSION }}.exe
            HMCL-${{ env.HMCL_VERSION }}.jar
            HMCL-${{ env.HMCL_VERSION }}.sh
          target_commitish: ${{ env.HMCL_COMMIT_SHA }}
          name: ${{ env.HMCL_TAG_NAME }}
          tag_name: ${{ env.HMCL_TAG_NAME }}
          prerelease: ${{ matrix.channel == 'dev' }}
